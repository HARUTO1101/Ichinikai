# 管理者画面 追加要件（パスワード認証＋サイドバーUI）

## 1. 認証・アクセス制御
- **方式**：Firebase Auth の **メール／パスワード**（管理者アカウントのみ発行）
- **ガード**：未認証時は `/login` に強制遷移。認証後 `/admin` へ。
- **権限**：`admin` クレーム必須。`cashier`/`kitchen` は任意で限定機能に入場可。
- **セッション**：永続（IndexedDB）／「この端末を記憶する」チェックで長期維持。
- **ログアウト**：サイドバー下部に常設。
- **パスワードポリシー**：8文字以上、大小英字／数字の混在（最低1種ずつ）。
- **総当たり対策**：連続失敗回数に応じたクールダウン（例：3回で30秒、5回で2分）。
- **パスワード再設定**：メールリンクで対応（管理者のみが自分のアカウントに利用可）。
- **MFA（任意）**：SMS または TOTP を有効化可能。
- **監査**：ログイン／ログアウト／失敗を `audits` に記録。

## 2. ナビゲーション／UI構造
- **レイアウト**：ヘッダ＋**ハンバーガーメニュー付サイドバー**＋コンテンツ領域。
- **ハンバーガー操作**：
  - モバイル：デフォルト閉。タップでスライドイン（オーバーレイ）。
  - デスクトップ：デフォルト開。アイコンで折りたたみ（ミニ幅）。
- **サイドバー項目**：
  1. **ダッシュボード（任意）**
  2. **注文一覧モード**（キッチンビュー）
  3. **QR支払いモード**（キャッシャービュー）
  4. **受付設定**（注文受け入れ可／不可トグル）
  5. **エクスポート**（任意）
  6. **設定**（役割表示、テーマ切替など）
  7. **ログアウト**
- **選択状態**：現在のモードにアクティブスタイル。URLに反映（例：`/admin/orders`、`/admin/pay`）。
- **レスポンシブ**：モバイル優先。主要ブレイクポイント：`<640px` / `≥640px` / `≥1024px`。

## 3. 画面別要件
### 3.1 注文一覧モード（キッチンビュー）
- **テーブル列**：時刻／注文番号／品目内訳／合計／支払い／進捗／操作。
- **リアルタイム反映**：`onSnapshot`＋`where(createdAt, '>', lastSeen)`（差分のみ）。
- **操作**：
  - 進捗を段階更新（受注済み→調理中→受取可→クローズ）。戻す操作は別メニューで任意許可。
  - 一括更新（選択行に対し進捗変更・支払い済み反映）。
- **フィルタ**：進捗、支払い、検索（注文ID・品目）。
- **ページング**：最新50件→無限スクロールで追加ロード。
- **アクセシビリティ**：キーボード操作、フォーカスリング、行ハイライト。

### 3.2 QR支払いモード（キャッシャービュー）
- **入力**：QR読み取り（ZXing）／チケット手入力。
- **表示**：注文番号・金額・品目・支払い状態。
- **操作**：「支払い済みにする」ボタン（`orders` と `orderLookup` をバッチ更新）。
- **連続運用**：完了後に自動でカメラに復帰（フォーカス保持、音・トースト通知）。
- **フォールバック**：カメラ不可時は手入力に自動切替。

### 3.3 受付設定
- **トグル**：`acceptingOrders`（true/false）。
- **メモ**：停止理由（例：材料切れ）を保存・表示。
- **反映**：クライアント側は即座に注文UIを非活性／理由表示。

## 4. コンポーネント要件（抜粋）
- **ハンバーガー**：`button[aria-controls="sidebar"]`／`aria-expanded` 適用。
- **サイドバー**：スクロール独立、アイコン＋ラベル。ミニ幅時はツールチップ表示。
- **通知**：新規注文時のバッジ／サウンド（ミュート切替）。
- **ダイアログ**：危険操作（全クローズ等）は確認モーダル。

## 5. 状態管理・データ取得
- **グローバル状態**：`auth user`、`roles`、`acceptingOrders`、未処理件数。
- **サブスク**：
  - `configs/runtime`：受付状態を `onSnapshot`。
  - `orders` 差分：`createdAt > lastSeen` のクエリを `onSnapshot`。
- **料金最適化**：差分購読／単一メタドキュメント監視（新規カウンタ）を併用可。

## 6. エラー・ローディング
- **ローディング**：スピナー／スケルトン（テーブル行ダミー）。
- **エラー**：トースト＋リトライ。権限不足は専用画面で案内。
- **ネットワーク**：オフライン検知（バナー）。復帰時に自動再同期。

## 7. セキュリティ・ルール追補（骨子）
```ruby
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 受付設定
    match /configs/runtime {
      allow read: if true;
      allow write: if request.auth.token.admin == true;
    }

    // 公開照会
    match /orderLookup/{ticket} {
      allow read: if true;
      allow write: if request.auth.token.admin == true;
    }

    // 注文本体（一覧・更新用）
    match /orders/{orderId} {
      allow read: if request.auth.token.admin == true || request.auth.token.kitchen == true || request.auth.token.cashier == true;
      allow update: if (request.auth.token.admin == true || request.auth.token.kitchen == true || request.auth.token.cashier == true)
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['payment','progress','updatedAt']);
      allow create, delete: if false;
    }
  }
}

## 8. 追加で推奨する機能
役割別クイック切替：サイドバー上部でビュー切替（キッチン／キャッシャー）。

ショートカット：1=調理中、2=受取可、3=クローズ、P=支払い済み。

集計（簡易）：当日件数・進捗別件数・売上合計のミニカード。

CSVエクスポート：当日／時間帯別など。

テーマ切替：ダークモード（屋外でも視認性を確保）。

## 9. 受け入れ基準（抜粋）
未認証時はログイン画面に誘導される。

サイドバーはハンバーガーで開閉でき、各モードへ遷移可能。

注文一覧で新規注文が2秒以内に追加表示される。

支払いモードで QR 読み取り→「支払い済み」更新が反映される。

受付トグル変更がクライアントの注文可否に反映される。

admin 以外は受付トグルを操作できない。


::contentReference[oaicite:0]{index=0}